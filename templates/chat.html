<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KMA TOOLS- Chat Room</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        body {
            background: url('https://www.toptal.com/designers/subtlepatterns/uploads/double-bubble-dark.png');
            font-family: Arial, sans-serif;
            color: #fff;
            margin: 0;
            padding: 0;
        }
        header {
            background: linear-gradient(135deg, #1a1a1a, #2c2c2c);
            padding: 10px 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        .flex {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        h1 {
            font-size: 2rem;
            margin: 0;
        }
        #hamburger {
            font-size: 1.5rem;
            cursor: pointer;
        }
        nav {
            background: #333;
            padding: 10px 0;
        }
        nav ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
        }
        nav li {
            margin: 0 20px;
        }
        nav a {
            color: #fff;
            text-decoration: none;
            font-size: 1rem;
            transition: color 0.3s;
        }
        nav a:hover {
            color: #00ff88;
        }
        main {
            padding: 20px 0;
        }
        h2 {
            font-size: 1.5rem;
            text-align: center;
            margin-bottom: 20px;
        }
        .room-code {
            text-align: center;
            margin-bottom: 20px;
        }
        .room-code span {
            font-weight: bold;
            color: #00ff88;
        }
        .room-code button {
            background: #00ff88;
            color: #000;
            border: none;
            padding: 5px 10px;
            margin-left: 10px;
            cursor: pointer;
            border-radius: 4px;
        }
        #chat-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        #chat-body {
            height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }
        .message {
            margin: 5px 0;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer; /* ÿ®ÿ±ÿß€å ⁄©ŸÑ€å⁄© ⁄©ÿ±ÿØŸÜ ÿ±Ÿà€å Ÿæ€åÿßŸÖ */
        }
        .message.user {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }
        .message.system {
            background: rgba(0, 0, 0, 0.5);
            color: #ccc;
            font-style: italic;
        }
        .message.join {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
            font-style: italic;
        }
        .message.leave {
            background: rgba(255, 0, 0, 0.2);
            color: #ff4444;
            font-style: italic;
        }
        .message.reply {
            border-left: 3px solid #00ff88;
            padding-left: 12px;
            background: rgba(255, 255, 255, 0.15);
        }
        .reply-info {
            font-size: 0.8rem;
            color: #aaa;
            margin-bottom: 5px;
        }
        .chat-input {
            display: flex;
        }
        #message-input {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 4px 0 0 4px;
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }
        #send-button {
            padding: 10px 20px;
            background: #00ff88;
            color: #000;
            border: none;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
        }
        #reply-box {
            display: none;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        #reply-box span {
            color: #00ff88;
        }
        #cancel-reply {
            color: #ff4444;
            cursor: pointer;
            margin-left: 10px;
        }
        #user-menu {
            display: none;
            position: absolute;
            right: 20px;
            top: 60px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #00ff88;
            border-radius: 4px;
            padding: 10px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        #user-menu h3 {
            margin: 0 0 10px;
            font-size: 1rem;
        }
        #user-menu ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #user-menu li {
            padding: 5px 0;
            color: #fff;
        }
        footer {
            background: #333;
            padding: 20px 0;
            text-align: center;
            margin-top: 20px;
        }
        footer p {
            margin: 5px 0;
        }
        footer a {
            color: #00ff88;
            text-decoration: none;
        }
        footer a:hover {
            text-decoration: underline;
        }
        .audio-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }
        .audio-controls button {
            background: #00ff88;
            color: #000;
            border: none;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <header>
        <div class="container flex">
            <h1>KMA Tools</h1>
            <div id="hamburger">‚ò∞</div>
        </div>
        <nav>
            <ul class="container flex">
                <li><a href="#">Shop</a></li>
                <li><a href="#">Discord</a></li>
                <li><a href="#">Webhook Msg</a></li>
                <li><a href="#">Panel</a></li>
            </ul>
        </nav>
    </header>

    <main class="container">
        <h2>Chat Room - Welcome {{ username }}</h2>
        {% if role == 'Owner' %}
        <div class="room-code">
            <p>Room Code: <span id="invite-code">{{ invite_code }}</span> <button id="copy-button">Copy</button></p>
        </div>
        {% endif %}
        <div id="chat-container">
            <div id="chat-body"></div>
            <div id="reply-box">
                Replying to: <span id="reply-username"></span> - <span id="reply-message"></span>
                <span id="cancel-reply">[Cancel]</span>
            </div>
            <div class="chat-input">
                <input type="text" id="message-input" placeholder="Type a message...">
                <button id="send-button">Send</button>
            </div>
        </div>
        <div id="user-menu">
            <h3>Online Users:</h3>
            <ul id="user-list"></ul>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 KMA Tools. All rights reserved.</p>
            <p>Follow us: <a href="#">Instagram</a> | <a href="#">Github</a></p>
            <p>Coded By AMIR KMA With Love ‚ù§Ô∏è</p>
        </div>
    </footer>

    <div class="audio-controls">
        <button id="mute-button">üîá</button>
        <button id="sound-button" style="display: none;">üîä</button>
    </div>

    <audio id="message-sound">
        <source src="/static/message.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <script>
        const socket = io({ transports: ['websocket', 'polling'] });
        const chatBody = document.getElementById('chat-body');
        const userList = document.getElementById('user-list');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const hamburger = document.getElementById('hamburger');
        const userMenu = document.getElementById('user-menu');
        const copyButton = document.getElementById('copy-button');
        const muteButton = document.getElementById('mute-button');
        const soundButton = document.getElementById('sound-button');
        const messageSound = document.getElementById('message-sound');
        const replyBox = document.getElementById('reply-box');
        const replyUsername = document.getElementById('reply-username');
        const replyMessage = document.getElementById('reply-message');
        const cancelReply = document.getElementById('cancel-reply');
        let isMuted = false;
        let replyingTo = null;

        socket.on('connect', () => {
            console.log('Connected to SocketIO server');
        });

        socket.on('message', (data) => {
            console.log('Received message:', data);
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${data.type || 'user'}${data.reply_to ? ' reply' : ''}`;
            messageDiv.dataset.messageId = data.id;

            if (data.reply_to) {
                const replyInfo = document.createElement('div');
                replyInfo.className = 'reply-info';
                const repliedMsg = rooms[sessionStorage.getItem('room_id')]?.chat_history?.find(msg => msg.id === data.reply_to) || {};
                replyInfo.textContent = `Replying to ${repliedMsg.username || 'Unknown'}: ${repliedMsg.message || ''}`;
                messageDiv.appendChild(replyInfo);
            }

            const messageText = document.createElement('span');
            messageText.textContent = `[${data.timestamp}] ${data.username}: ${data.message}`;
            messageDiv.appendChild(messageText);

            messageDiv.addEventListener('click', () => {
                replyingTo = data.id;
                replyUsername.textContent = data.username;
                replyMessage.textContent = data.message;
                replyBox.style.display = 'block';
                messageInput.focus();
            });

            chatBody.appendChild(messageDiv);
            chatBody.scrollTop = chatBody.scrollHeight;
            if (!isMuted) {
                messageSound.play().catch(err => console.log('Audio play error:', err));
            }
        });

        socket.on('user_list', (data) => {
            console.log('Received user list:', data);
            userList.innerHTML = '';
            data.users.forEach(user => {
                const li = document.createElement('li');
                li.textContent = `${user.username} (${user.role})`;
                userList.appendChild(li);
            });
        });

        socket.on('room_closed', (data) => {
            console.log('Room closed:', data);
            alert(data.message);
            window.location.href = '/';
        });

        socket.on('kick', (data) => {
            console.log('Kicked:', data);
            alert(data.message);
            window.location.href = '/';
        });

        socket.on('ban', (data) => {
            console.log('Banned:', data);
            alert(data.message);
            window.location.href = '/';
        });

        sendButton.addEventListener('click', () => {
            sendMessage();
        });

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        function sendMessage() {
            const message = messageInput.value.trim();
            if (message) {
                const messageData = { message: message };
                if (replyingTo) {
                    messageData.reply_to = replyingTo;
                }
                socket.emit('message', messageData);
                console.log('Sent message:', messageData);
                messageInput.value = '';
                if (replyingTo) {
                    replyingTo = null;
                    replyBox.style.display = 'none';
                }
            }
        }

        cancelReply.addEventListener('click', () => {
            replyingTo = null;
            replyBox.style.display = 'none';
        });

        hamburger.addEventListener('click', () => {
            userMenu.style.display = userMenu.style.display === 'block' ? 'none' : 'block';
        });

        if (copyButton) {
            copyButton.addEventListener('click', () => {
                const inviteCode = document.getElementById('invite-code').textContent;
                navigator.clipboard.writeText(inviteCode).then(() => {
                    alert('Invite code copied to clipboard!');
                });
            });
        }

        muteButton.addEventListener('click', () => {
            isMuted = true;
            muteButton.style.display = 'none';
            soundButton.style.display = 'inline';
        });

        soundButton.addEventListener('click', () => {
            isMuted = false;
            muteButton.style.display = 'inline';
            soundButton.style.display = 'none';
        });

        // ÿ∞ÿÆ€åÿ±Ÿá ÿ™ÿßÿ±€åÿÆ⁄ÜŸá ŸÖÿ≠ŸÑ€å ÿ®ÿ±ÿß€å ÿØÿ≥ÿ™ÿ±ÿ≥€å ÿ®Ÿá reply_to
        const roomId = '{{ session["room_id"] }}';
        if (!rooms[roomId]) {
            rooms[roomId] = { chat_history: [] };
        }
        socket.on('message', (data) => {
            rooms[roomId].chat_history.push(data);
        });
    </script>
</body>
</html>
